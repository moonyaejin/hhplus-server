# 콘서트 예약 시스템 부하 테스트 계획서

## 1. 개요

### 1.1 배경
콘서트 예약 서비스는 티켓 오픈 시 순간적으로 트래픽이 집중되는 특성이 있습니다.
특히 결제 처리는 사용자 잔액의 정확성이 보장되어야 하며,
동시 요청 상황에서도 데이터 정합성이 유지되어야 합니다.

이는 금융 시스템의 계좌이체와 동일한 수준의 신뢰성을 요구합니다:
- 중복 결제 방지
- 잔액 정합성 100% 보장
- 동시 요청 시 순서 보장

### 1.2 목적
1. 시스템의 최대 처리량(TPS) 및 한계점 파악
2. 리소스별 적정 배포 스펙 도출
3. 병목 구간 식별 및 개선 방향 수립
4. SLA(Service Level Agreement) 기준 수립

---

## 2. 테스트 대상 선정

### 2.1 대상 API 및 선정 이유

| 우선순위 | API | 선정 이유 |
|---------|-----|----------|
| 1 | `POST /api/reservations/confirm` | 결제 처리 - 잔액 차감의 동시성 제어 및 데이터 정합성 검증 |
| 2 | `POST /api/reservations/temporary-assign` | 좌석 배정 - 선착순 경쟁 상황에서의 락 처리 검증 |
| 3 | `GET /api/wallet/{userId}/balance` | 잔액 조회 - 읽기 성능 및 캐시 효과 검증 |

### 2.2 왜 이 API들인가?

**결제 확정 API (1순위)**
- 비즈니스 핵심: 매출과 직결되는 트랜잭션
- 기술적 난이도: 잔액 차감 + 좌석 확정 + 이벤트 발행이 하나의 트랜잭션
- 리스크: 장애 시 금전적 손실 및 고객 신뢰도 하락

**좌석 임시 배정 API (2순위)**
- 티켓 오픈 순간 가장 높은 트래픽 집중
- 분산 락을 통한 동시성 제어 검증 필요

**잔액 조회 API (3순위)**
- 가장 빈번한 호출 예상
- 캐싱 전략의 효과 측정

---

## 3. 테스트 시나리오

### 3.1 테스트 유형

| 유형 | 목적 | 방법 |
|------|------|------|
| **Load Test** | 예상 트래픽에서 정상 동작 확인 | 목표 TPS까지 점진적 증가 |
| **Stress Test** | 시스템 한계점 파악 | 한계 초과까지 부하 증가 |
| **Spike Test** | 순간 트래픽 급증 대응 | 티켓 오픈 시나리오 시뮬레이션 |

### 3.2 단계별 부하 시나리오

| 단계 | 가상 사용자(VU) | 목표 TPS | 지속 시간 | Docker 스펙 |
|------|----------------|----------|----------|-------------|
| 1단계 | 50 | ~100 | 2분 | 1 CPU, 512MB |
| 2단계 | 100 | ~300 | 2분 | 1 CPU, 512MB |
| 3단계 | 200 | ~500 | 3분 | 2 CPU, 1GB |
| 4단계 | 500 | ~1000 | 3분 | 2 CPU, 2GB |

### 3.3 사용자 시나리오 (티켓팅 플로우)
```
1. 대기열 토큰 발급 → POST /api/queue/token
2. 콘서트 정보 조회 → GET /api/concerts/{id}
3. 좌석 임시 배정   → POST /api/reservations/temporary-assign
4. 잔액 확인       → GET /api/wallet/{userId}/balance
5. 결제 확정       → POST /api/reservations/confirm
```

---

## 4. 성공 기준 (SLA)

| 지표 | 기준 | 비고 |
|------|------|------|
| 응답 시간 P95 | < 500ms | 사용자 체감 품질 |
| 응답 시간 P99 | < 1000ms | 최악 상황 허용치 |
| 에러율 | < 1% | 비즈니스 요청 제외 |
| 데이터 정합성 | 100% | 잔액 불일치 0건 |
| TPS | > 500 | 최소 목표 |

---

## 5. 테스트 환경

### 5.1 인프라 구성

| 구성요소 | 스펙 | 비고 |
|---------|------|------|
| Application | Docker (스펙 가변) | Spring Boot 3.x |
| Database | MySQL 8.0 (Docker) | 2 CPU, 2GB |
| Cache | Redis 7.x (Docker) | 1 CPU, 512MB |
| Load Generator | k6 | 로컬 실행 |

### 5.2 도구

- **부하 테스트**: k6
- **모니터링**: Docker stats, Application logs
- **결과 분석**: k6 내장 리포트

---

## 6. 리스크 및 대응

| 리스크 | 영향 | 대응 방안 |
|--------|------|----------|
| DB 커넥션 풀 고갈 | 요청 실패 급증 | 커넥션 풀 모니터링, 적정값 튜닝 |
| Redis 장애 | 대기열/캐시 불가 | Fallback 로직 검증 |
| 메모리 부족 (OOM) | 컨테이너 재시작 | 메모리 사용량 모니터링 |

---

## 7. 산출물

1. 테스트 스크립트
2. 테스트 결과 리포트
3. 리소스별 성능 비교표
4. 적정 배포 스펙 권고안
5. 장애 대응 매뉴얼